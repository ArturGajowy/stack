name: Standard

on:
  push:
    branches:
    - master
    - stable
    - rc/*
    - action-testing # FIXME remove
  pull_request: {}
  

jobs:
  Style:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Style
        run: |
          ./etc/scripts/get-hlint.sh
          export PATH="$(pwd)"/hlint:$PATH
          hlint src/
          hlint src/ --cpp-define=WINDOWS=1
          hlint test/ --cpp-simple

  GHC matrix:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target: ["ghc-8.4", "ghc-8.6", "ghc-8.8"]
        include:
          - target: ghc-8.4
            stack_yaml: stack-ghc-84.yaml
          - target: ghc-8.6
            stack_yaml: stack-ghc-86.yaml
          - target: ghc-8.8
            stack_yaml: stack-ghc-88.yaml

    steps:
      - uses: actions/checkout@v2

      - name: Cache .stack-root
        uses: actions/cache@v1
        env:
          cache-name: stack-root
        with:
          path: .stack-root
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(matrix.stack_yaml) }}

      - name: Test
        run: |
          set -ex
          export STACK_ROOT=$(pwd)/.stack-root
          stack --stack-yaml ${{ matrix.stack_yaml }} test --haddock --no-haddock-deps

  Linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cache .stack-root
        uses: actions/cache@v1
        env:
          cache-name: stack-root
        with:
          path: .stack-root
          key: ${{ runner.os }}-static-build-${{ env.cache-name }}-${{ hashFiles('stack.yaml') }}

      - name: Test
        run: |
          set -ex
          export STACK_ROOT=$(pwd)/.stack-root
          curl -sSL https://get.haskellstack.org/ | sh
          stack etc/scripts/release.hs check --alpine
          stack etc/scripts/release.hs build --alpine

      - uses: actions/upload-artifact@v1
        with:
          name: linux
          path: _release

  MacOS:
    runs-on: macOS-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cache .stack-root
        uses: actions/cache@v1
        env:
          cache-name: stack-root
        with:
          path: .stack-root
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('stack.yaml') }}

      - name: Test
        run: |
          set -ex
          export STACK_ROOT=$(pwd)/.stack-root
          curl -sSL https://get.haskellstack.org/ | sh
          stack etc/scripts/release.hs check
          stack etc/scripts/release.hs build

      - uses: actions/upload-artifact@v1
        with:
          name: macos
          path: _release

  Windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cache .stack-root
        uses: actions/cache@v1
        env:
          cache-name: stack-root
        with:
          path: .stack-root
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('stack.yaml') }}

      - name: Test
        shell: bash
        run: |
          export STACK_ROOT=$(pwd)/.stack-root
          curl -sSkL http://www.stackage.org/stack/windows-x86_64 -o /usr/bin/stack.zip
          stack etc/scripts/release.hs check
          stack etc/scripts/release.hs build

      - uses: actions/upload-artifact@v1
        with:
          name: windows
          path: _release
